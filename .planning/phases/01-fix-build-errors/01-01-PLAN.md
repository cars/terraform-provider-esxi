---
phase: 01-fix-build-errors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - esxi/data_source_esxi_host.go
autonomous: true

must_haves:
  truths:
    - "Provider compiles without errors"
    - "esxi_host data source reads host info via govmomi when useGovmomi flag is true"
    - "esxi_host data source reads host info via SSH when useGovmomi flag is false"
  artifacts:
    - path: "esxi/data_source_esxi_host.go"
      provides: "Complete esxi_host data source implementation"
      exports: ["dataSourceEsxiHost", "dataSourceEsxiHostRead", "dataSourceEsxiHostReadGovmomi", "dataSourceEsxiHostReadSSH"]
      min_lines: 400
  key_links:
    - from: "dataSourceEsxiHostRead"
      to: "dataSourceEsxiHostReadGovmomi"
      via: "c.useGovmomi flag routing"
      pattern: "if c\\.useGovmomi.*dataSourceEsxiHostReadGovmomi"
    - from: "dataSourceEsxiHostReadSSH"
      to: "getHostInfoSSH"
      via: "ConnectionStruct parameter"
      pattern: "getHostInfoSSH\\(esxiConnInfo\\)"
    - from: "dataSourceEsxiHostReadGovmomi"
      to: "getHostSystem"
      via: "govmomi helper function call"
      pattern: "getHostSystem\\(ctx, gc\\.Finder\\)"
---

<objective>
Fix all compilation errors in esxi/data_source_esxi_host.go to establish a working build and testing baseline.

Purpose: Enable subsequent SSH removal work by ensuring provider compiles cleanly and all tests pass. Without a working build, no validation is possible.

Output: Clean compilation with `go build ./...` and passing test suite (`go test ./esxi/ -v`).
</objective>

<execution_context>
@/home/cars/.claude/get-shit-done/workflows/execute-plan.md
@/home/cars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/cars/src/github/cars/terraform-provider-esxi/.planning/PROJECT.md
@/home/cars/src/github/cars/terraform-provider-esxi/.planning/ROADMAP.md
@/home/cars/src/github/cars/terraform-provider-esxi/.planning/STATE.md
@/home/cars/src/github/cars/terraform-provider-esxi/.planning/phases/01-fix-build-errors/01-RESEARCH.md

# Codebase context
@/home/cars/src/github/cars/terraform-provider-esxi/.planning/codebase/ARCHITECTURE.md
@/home/cars/src/github/cars/terraform-provider-esxi/.planning/codebase/CONVENTIONS.md

# Reference files for patterns
@/home/cars/src/github/cars/terraform-provider-esxi/esxi/govmomi_helpers.go
@/home/cars/src/github/cars/terraform-provider-esxi/esxi/connection_info.go
@/home/cars/src/github/cars/terraform-provider-esxi/esxi/data_source_esxi_host.go
@/home/cars/src/github/cars/terraform-provider-esxi/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Fix SSH helper function type signatures</name>
  <files>esxi/data_source_esxi_host.go</files>
  <action>
Fix the three SSH helper functions to accept `ConnectionStruct` instead of `map[string]string`:

1. Line 170: Change `getHostInfoSSH(esxiConnInfo map[string]string)` to `getHostInfoSSH(esxiConnInfo ConnectionStruct)`
2. Line 205: Change `getHardwareInfoSSH(esxiConnInfo map[string]string)` to `getHardwareInfoSSH(esxiConnInfo ConnectionStruct)`
3. Line 288: Change `getDatastoresSSH(esxiConnInfo map[string]string)` to `getDatastoresSSH(esxiConnInfo ConnectionStruct)`

This fixes the type mismatch errors where these functions are called with `ConnectionStruct` from `getConnectionInfo(c)` but declared to accept `map[string]string`. The `runRemoteSshCommand` function signature (esxi_remote_cmds.go line 71) expects `ConnectionStruct`, so all callers must pass the correct type.

Keep all function bodies unchanged - only update the parameter type in the function signatures.
  </action>
  <verify>Run `go build ./...` and confirm no type mismatch errors related to ConnectionStruct vs map[string]string</verify>
  <done>Build succeeds past the type mismatch errors; only the missing function error remains</done>
</task>

<task type="auto">
  <name>Implement dataSourceEsxiHostReadGovmomi function</name>
  <files>esxi/data_source_esxi_host.go</files>
  <action>
Add the missing `dataSourceEsxiHostReadGovmomi` function after the `dataSourceEsxiHostReadSSH` function (around line 315). Follow the established dual-path pattern from RESEARCH.md.

Implementation pattern (based on research examples):
```go
func dataSourceEsxiHostReadGovmomi(d *schema.ResourceData, c *Config) error {
	gc, err := c.GetGovmomiClient()
	if err != nil {
		return fmt.Errorf("Failed to get govmomi client: %s", err)
	}

	ctx := gc.Context()

	// Get host system (standalone ESXi has one default host)
	host, err := getHostSystem(ctx, gc.Finder)
	if err != nil {
		return fmt.Errorf("Failed to get host system: %s", err)
	}

	// Retrieve properties in a single API call
	var mo mo.HostSystem
	err = host.Properties(ctx, host.Reference(), []string{
		"summary.hardware",
		"summary.config",
		"hardware.systemInfo",
		"datastore",
	}, &mo)
	if err != nil {
		return fmt.Errorf("Failed to get host properties: %s", err)
	}

	// Set Terraform state from managed object properties
	d.SetId(c.esxiHostName)
	d.Set("hostname", c.esxiHostName)

	// Map mo properties to schema fields:
	// version: mo.Summary.Config.Product.Version + "-" + mo.Summary.Config.Product.Build
	// product_name: mo.Summary.Config.Product.FullName
	// uuid: mo.Summary.Hardware.Uuid
	// manufacturer: mo.Hardware.SystemInfo.Vendor
	// model: mo.Hardware.SystemInfo.Model
	// serial_number: mo.Hardware.SystemInfo.SerialNumber (if available)
	// cpu_model: mo.Summary.Hardware.CpuModel
	// cpu_packages: mo.Summary.Hardware.NumCpuPkgs (int16 -> int conversion)
	// cpu_cores: mo.Summary.Hardware.NumCpuCores (int16 -> int conversion)
	// cpu_threads: mo.Summary.Hardware.NumCpuThreads (int16 -> int conversion)
	// cpu_mhz: mo.Summary.Hardware.CpuMhz (int32 -> int conversion)
	// memory_size: mo.Summary.Hardware.MemorySize / (1024 * 1024) (bytes to MB)

	// For datastores: iterate mo.Datastore refs, fetch each datastore's summary for name/type/capacity/free
	// Build []map[string]interface{} for datastores list

	log.Printf("[dataSourceEsxiHostReadGovmomi] Successfully read ESXi host '%s'", c.esxiHostName)
	return nil
}
```

Add import for `"github.com/vmware/govmomi/vim25/mo"` if not already present.

Match the exact schema fields from lines 18-107. Handle nil-safe property access for optional fields (e.g., serial_number, vendor may be empty).

Use established error wrapping pattern: `fmt.Errorf("Failed to ... : %s", err)` matching SSH path style.
  </action>
  <verify>Run `go build ./...` and confirm successful compilation with no errors</verify>
  <done>Provider builds cleanly without compilation errors</done>
</task>

<task type="auto">
  <name>Verify build and run tests</name>
  <files></files>
  <action>
Run the complete test suite to ensure the build fix doesn't break existing functionality:

1. Build check: `go build ./...`
2. Run tests: `go test ./esxi/ -v`

If any tests fail, examine output and fix issues. Expected: all existing tests should pass (the esxi_host data source may not have dedicated tests yet, but other tests should continue working).

Note any test failures in commit message if they exist prior to this fix.
  </action>
  <verify>Run `go test ./esxi/ -v` and confirm exit code 0 (all tests pass)</verify>
  <done>Build succeeds (`go build ./...` returns 0) and test suite passes (`go test ./esxi/ -v` returns 0 failures)</done>
</task>

</tasks>

<verification>
Run these commands to verify phase completion:

1. **Compilation check**: `go build ./...` → should complete without errors
2. **Missing function check**: `grep -n "dataSourceEsxiHostReadGovmomi" esxi/data_source_esxi_host.go` → should show function definition (not just call site)
3. **Type signature check**: `grep -n "func getHostInfoSSH" esxi/data_source_esxi_host.go` → should show `ConnectionStruct` parameter
4. **Test suite**: `go test ./esxi/ -v` → should return 0 failures

All four checks must pass for phase completion.
</verification>

<success_criteria>
1. Provider compiles cleanly: `go build ./...` exits with code 0
2. Function `dataSourceEsxiHostReadGovmomi` exists in esxi/data_source_esxi_host.go
3. All three SSH helper functions use `ConnectionStruct` parameter type
4. Test suite passes: `go test ./esxi/ -v` reports 0 failures
5. Git commit created documenting the build fix
</success_criteria>

<output>
After completion, create `.planning/phases/01-fix-build-errors/01-01-SUMMARY.md` using the summary template.
</output>
