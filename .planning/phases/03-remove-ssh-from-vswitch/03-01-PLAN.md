---
phase: 03-remove-ssh-from-vswitch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - esxi/vswitch_functions.go
  - esxi/vswitch_create.go
  - esxi/vswitch_delete.go
  - esxi/vswitch_import.go
autonomous: true

must_haves:
  truths:
    - "vswitch_functions.go contains zero SSH code paths (no runRemoteSshCommand, getConnectionInfo, esxiConnInfo, esxcli, remote_cmd)"
    - "vswitch_create.go calls vswitchCreate_govmomi directly without useGovmomi conditional"
    - "vswitch_delete.go calls vswitchDelete_govmomi directly without useGovmomi conditional"
    - "vswitch_import.go uses vswitchRead (govmomi) instead of SSH commands to verify existence"
    - "All vswitch tests pass (accounting for known simulator limitations)"
    - "All portgroup tests still pass (no regressions in network dependencies)"
    - "data_source_esxi_vswitch.go requires no changes (auto-fixed via shared vswitchRead)"
  artifacts:
    - path: "esxi/vswitch_functions.go"
      provides: "SSH-free vswitchUpdate and vswitchRead wrapper functions"
      contains: "return vswitchRead_govmomi"
    - path: "esxi/vswitch_create.go"
      provides: "Direct govmomi vswitch creation"
      contains: "vswitchCreate_govmomi"
    - path: "esxi/vswitch_delete.go"
      provides: "Direct govmomi vswitch deletion"
      contains: "vswitchDelete_govmomi"
    - path: "esxi/vswitch_import.go"
      provides: "Govmomi-based vswitch import verification"
      contains: "vswitchRead"
  key_links:
    - from: "esxi/vswitch_functions.go"
      to: "vswitchRead_govmomi, vswitchUpdate_govmomi"
      via: "thin wrapper functions"
      pattern: "return vswitchRead_govmomi|return vswitchUpdate_govmomi"
    - from: "esxi/vswitch_import.go"
      to: "esxi/vswitch_functions.go"
      via: "vswitchRead function call"
      pattern: "vswitchRead\\(c,"
    - from: "esxi/data_source_esxi_vswitch.go"
      to: "esxi/vswitch_functions.go"
      via: "shared vswitchRead function (auto-fixed)"
      pattern: "vswitchRead\\(c,"
---

<objective>
Remove all SSH code paths from the vSwitch resource, making it operate entirely via govmomi API.

Purpose: Completes networking resource cleanup (portgroup done in Phase 2, vswitch here). Follows the proven SSH removal pattern established in Phase 2.
Output: SSH-free vswitch resource with all CRUD and import operations using govmomi.
</objective>

<execution_context>
@/home/cars/.claude/get-shit-done/workflows/execute-plan.md
@/home/cars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-remove-ssh-from-portgroup/02-01-SUMMARY.md
@.planning/phases/03-remove-ssh-from-vswitch/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove SSH branches from vSwitch CRUD functions</name>
  <files>esxi/vswitch_functions.go, esxi/vswitch_create.go, esxi/vswitch_delete.go</files>
  <action>
Follow the exact Phase 2 portgroup pattern to remove SSH code from 3 vswitch files:

**esxi/vswitch_functions.go:**
1. Replace `vswitchUpdate` function (lines 14-96) with a thin wrapper:
   ```go
   func vswitchUpdate(c *Config, name string, ports int, mtu int, uplinks []string,
       link_discovery_mode string, promiscuous_mode bool, mac_changes bool, forged_transmits bool) error {
       return vswitchUpdate_govmomi(c, name, ports, mtu, uplinks, link_discovery_mode, promiscuous_mode, mac_changes, forged_transmits)
   }
   ```
2. Replace `vswitchRead` function (lines 98-186) with a thin wrapper:
   ```go
   func vswitchRead(c *Config, name string) (int, int, []string, string, bool, bool, bool, error) {
       return vswitchRead_govmomi(c, name)
   }
   ```
3. Keep `inArrayOfStrings` utility function (lines 188-196) and its comment - it has dedicated tests and is harmless.
4. Keep all govmomi implementation functions unchanged (lines 198-426).
5. Remove unused imports that become dead code after SSH removal: `regexp`, `strconv`, `strings`. Keep `fmt`, `log`, `govmomi/vim25/mo`, `govmomi/vim25/types`.

**esxi/vswitch_create.go:**
1. Remove the SSH else-branch (lines 75-88) from the create section.
2. Remove the `if c.useGovmomi` conditional - call `vswitchCreate_govmomi` directly:
   ```go
   err = vswitchCreate_govmomi(c, name, ports)
   if err != nil {
       d.SetId("")
       if strings.Contains(err.Error(), "already exists") {
           return fmt.Errorf("Failed to add vswitch: %s, it already exists\n", name)
       }
       return fmt.Errorf("Failed to add vswitch: %s\n", err)
   }
   ```
3. Remove unused variables: `remote_cmd` (line 17), and `esxiConnInfo` (line 13) since SSH connection is no longer needed.
4. Keep `strings` import since `strings.Contains` is used for the "already exists" error check.

**esxi/vswitch_delete.go:**
1. Remove the `if c.useGovmomi` conditional and SSH else-branch (lines 22-33).
2. Call `vswitchDelete_govmomi` directly:
   ```go
   err := vswitchDelete_govmomi(c, name)
   if err != nil {
       log.Printf("[resourceVSWITCHDelete] Failed destroy vswitch: %s\n", err)
       return fmt.Errorf("Failed to destroy vswitch: %s\n", err)
   }
   ```

**Critical constraints:**
- Do NOT modify `resource_vswitch.go` (schema file, no CRUD logic)
- Do NOT modify `data_source_esxi_vswitch.go` (auto-fixed via shared vswitchRead)
- Do NOT modify `vswitch_read.go` or `vswitch_update.go` (they call vswitchRead/vswitchUpdate, auto-fixed)
- Do NOT remove `useGovmomi` flag from Config (Phase 6)
- Do NOT rename `_govmomi` functions (Phase 6)
- Keep `inArrayOfStrings` function and its tests
  </action>
  <verify>
Run `go build ./...` to confirm clean compilation. Then run:
```bash
grep -n 'runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo\|esxcli\|remote_cmd' esxi/vswitch_functions.go esxi/vswitch_create.go esxi/vswitch_delete.go
```
Must return zero matches. Verify `vswitchRead` and `vswitchUpdate` are thin wrappers by checking they contain only a single return statement delegating to `_govmomi` functions.
  </verify>
  <done>
vswitch_functions.go has vswitchUpdate and vswitchRead as thin wrappers calling govmomi implementations with zero SSH code. vswitch_create.go calls vswitchCreate_govmomi directly. vswitch_delete.go calls vswitchDelete_govmomi directly. No SSH identifiers remain in any of the 3 files. Build compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite vSwitch import to use govmomi and verify all tests pass</name>
  <files>esxi/vswitch_import.go</files>
  <action>
**esxi/vswitch_import.go:**
Rewrite the entire function to use govmomi-based `vswitchRead` instead of SSH commands. Follow the exact Phase 2 portgroup import pattern from `portgroup_import.go`:

```go
package esxi

import (
	"fmt"
	"log"

	"github.com/hashicorp/terraform/helper/schema"
)

func resourceVSWITCHImport(d *schema.ResourceData, m interface{}) ([]*schema.ResourceData, error) {
	c := m.(*Config)
	log.Println("[resourceVSWITCHImport]")

	results := make([]*schema.ResourceData, 1, 1)
	results[0] = d

	// Use govmomi to verify vswitch exists
	_, _, _, _, _, _, _, err := vswitchRead(c, d.Id())
	if err != nil {
		return results, fmt.Errorf("Failed to import vswitch '%s': %s", d.Id(), err)
	}

	d.SetId(d.Id())
	d.Set("name", d.Id())

	return results, nil
}
```

Key differences from portgroup import: vswitchRead returns 8 values (7 fields + error) while portgroupRead returns 3 (2 fields + error), so use 7 blank identifiers before err.

**Verification steps:**
1. Run `go build ./...` - must compile cleanly
2. Run `grep -rn 'runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo\|esxcli\|remote_cmd' esxi/vswitch_*.go` - must return zero matches across ALL vswitch files
3. Run `go test ./esxi/ -v -run TestVswitch` - expect TestInArrayOfStrings and TestVswitchCreateReadDeleteGovmomi to pass, TestVswitchUpdateGovmomi to fail (known simulator limitation)
4. Run `go test ./esxi/ -v -run TestPortgroup` - expect 3/4 passing (same as Phase 2 baseline, validates no regressions)
5. Run full test suite `go test ./esxi/ -v` - expect 27/32 passing (same as Phase 1/2 baseline)
  </action>
  <verify>
```bash
# Build check
go build ./...

# Zero SSH in all vswitch files
grep -rn 'runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo\|esxcli\|remote_cmd' esxi/vswitch_*.go

# VSwitch tests
go test ./esxi/ -v -run TestVswitch

# Portgroup regression check
go test ./esxi/ -v -run TestPortgroup

# Full suite baseline
go test ./esxi/ -v 2>&1 | tail -5
```
  </verify>
  <done>
vswitch_import.go uses govmomi-based vswitchRead for import verification with zero SSH code. All vswitch files contain no SSH identifiers. VSwitch tests pass (accounting for known simulator limitations). Portgroup tests show no regressions. Full test suite maintains 27/32 baseline.
  </done>
</task>

</tasks>

<verification>
1. **Build check:** `go build ./...` compiles without errors
2. **SSH elimination:** `grep -rn 'runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo\|esxcli\|remote_cmd' esxi/vswitch_*.go` returns zero matches
3. **Wrapper pattern:** vswitchRead and vswitchUpdate are thin wrappers (single return line delegating to _govmomi)
4. **Import pattern:** vswitch_import.go calls vswitchRead to verify existence (matches portgroup pattern)
5. **VSwitch tests:** `go test ./esxi/ -v -run TestVswitch` shows expected results (accounting for simulator limitations)
6. **No regressions:** `go test ./esxi/ -v -run TestPortgroup` shows 3/4 passing (same as Phase 2 baseline)
7. **Full baseline:** `go test ./esxi/ -v` shows 27/32 passing (same overall baseline)
8. **Data source unmodified:** `data_source_esxi_vswitch.go` has no changes (auto-fixed via shared vswitchRead)
</verification>

<success_criteria>
- vswitch_functions.go contains zero SSH code paths
- vswitch_create.go calls vswitchCreate_govmomi directly (no useGovmomi conditional)
- vswitch_delete.go calls vswitchDelete_govmomi directly (no useGovmomi conditional)
- vswitch_import.go uses govmomi read instead of SSH commands
- All vswitch files are SSH-free (zero matches for SSH identifiers)
- Build compiles cleanly
- Test baseline maintained (27/32 passing)
- inArrayOfStrings utility function preserved with tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-remove-ssh-from-vswitch/03-01-SUMMARY.md`
</output>
