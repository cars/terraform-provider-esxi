---
phase: 05-remove-ssh-from-virtual-disk
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - esxi/virtual-disk_functions.go
  - esxi/virtual-disk_delete.go
  - esxi/data_source_esxi_virtual_disk.go
autonomous: true

must_haves:
  truths:
    - "Virtual disk create/read/grow operations work without SSH"
    - "Virtual disk delete operation works via govmomi API"
    - "Data source can find virtual disks in a directory without SSH"
    - "Existing Terraform state path format (/vmfs/volumes/) is preserved"
    - "All virtual disk tests pass (same baseline as before)"
  artifacts:
    - path: "esxi/virtual-disk_functions.go"
      provides: "SSH-free wrapper functions for diskStoreValidate, virtualDiskCREATE, virtualDiskREAD, growVirtualDisk, plus new virtualDiskDelete_govmomi"
      contains: "func virtualDiskDelete_govmomi"
    - path: "esxi/virtual-disk_delete.go"
      provides: "SSH-free delete operation using virtualDiskDelete_govmomi"
      min_lines: 10
    - path: "esxi/data_source_esxi_virtual_disk.go"
      provides: "SSH-free findVirtualDiskInDir wrapper and full findVirtualDiskInDir_govmomi implementation"
      contains: "browser.SearchDatastore"
  key_links:
    - from: "esxi/virtual-disk_delete.go"
      to: "esxi/virtual-disk_functions.go"
      via: "virtualDiskDelete_govmomi call"
      pattern: "virtualDiskDelete_govmomi"
    - from: "esxi/data_source_esxi_virtual_disk.go"
      to: "esxi/virtual-disk_functions.go"
      via: "diskStoreValidate and virtualDiskREAD wrapper calls"
      pattern: "diskStoreValidate|virtualDiskREAD"
    - from: "esxi/virtual-disk_create.go"
      to: "esxi/virtual-disk_functions.go"
      via: "virtualDiskCREATE wrapper call (auto-fixed, no changes needed)"
      pattern: "virtualDiskCREATE"
---

<objective>
Remove all SSH code paths from virtual disk resource and implement missing govmomi delete function.

Purpose: Complete SSH removal from virtual disk resource (VDISK-01 through VDISK-04), following the proven wrapper pattern from Phases 2-4. This is the most complex SSH removal due to the missing virtualDiskDelete_govmomi implementation and the stubbed findVirtualDiskInDir_govmomi function.

Output: Virtual disk resource operates entirely via govmomi API. All CRUD operations, import, and data source work without SSH. Path format compatibility preserved.
</objective>

<execution_context>
@/home/cars/.claude/get-shit-done/workflows/execute-plan.md
@/home/cars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-remove-ssh-from-virtual-disk/05-RESEARCH.md

@esxi/virtual-disk_functions.go
@esxi/virtual-disk_delete.go
@esxi/data_source_esxi_virtual_disk.go
@esxi/virtual-disk_create.go
@esxi/virtual-disk_read.go
@esxi/virtual-disk_update.go
@esxi/virtual-disk_import.go
@esxi/virtual-disk_functions_test.go
@esxi/govmomi_helpers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove SSH branches from virtual-disk_functions.go and add virtualDiskDelete_govmomi</name>
  <files>esxi/virtual-disk_functions.go</files>
  <action>
Apply the proven Phase 2-4 wrapper pattern to all four SSH-routed functions, and add the missing virtualDiskDelete_govmomi function.

**Step 1: Replace diskStoreValidate with thin wrapper (lines 17-56)**
Remove the SSH branch (lines 18-55). Replace the entire function body with:
```go
func diskStoreValidate(c *Config, disk_store string) error {
    return diskStoreValidate_govmomi(c, disk_store)
}
```

**Step 2: Replace virtualDiskCREATE with thin wrapper (lines 61-118)**
Remove the SSH branch (lines 63-117). Replace the entire function body with:
```go
func virtualDiskCREATE(c *Config, virtual_disk_disk_store string, virtual_disk_dir string,
    virtual_disk_name string, virtual_disk_size int, virtual_disk_type string) (string, error) {
    return virtualDiskCREATE_govmomi(c, virtual_disk_disk_store, virtual_disk_dir, virtual_disk_name, virtual_disk_size, virtual_disk_type)
}
```

**Step 3: Replace growVirtualDisk with thin wrapper (lines 123-152)**
Remove the SSH branch (lines 125-151). Replace the entire function body with:
```go
func growVirtualDisk(c *Config, virtdisk_id string, virtdisk_size string) (bool, error) {
    return growVirtualDisk_govmomi(c, virtdisk_id, virtdisk_size)
}
```

**Step 4: Replace virtualDiskREAD with thin wrapper (lines 157-231)**
Remove the SSH branch (lines 159-230). Replace the entire function body with:
```go
func virtualDiskREAD(c *Config, virtdisk_id string) (string, string, string, int, string, error) {
    return virtualDiskREAD_govmomi(c, virtdisk_id)
}
```

**Step 5: Add virtualDiskDelete_govmomi function**
Add after growVirtualDisk_govmomi (after line 499). Implementation per research:
- Parse virtdisk_id (/vmfs/volumes/datastore/dir/disk.vmdk) into components using the same split logic as virtualDiskREAD_govmomi
- Get govmomi client, get datastore via getDatastoreByName
- Convert to [datastore] path format using ds.Path()
- Create VirtualDiskManager via object.NewVirtualDiskManager(gc.Client.Client)
- Call dm.DeleteVirtualDisk(gc.Context(), diskPath, nil) -- nil datacenter for standalone ESXi
- Wait for task with waitForTask
- Handle "not found" / "does not exist" errors as success (idempotent delete)
- Do NOT replicate SSH directory cleanup logic (govmomi handles this)

**Step 6: Clean up imports**
Remove unused imports that were only needed by SSH code paths:
- Remove "errors" (used only in SSH virtualDiskCREATE)
- Remove "strconv" (used only in SSH growVirtualDisk)
- Keep "fmt", "log", "strings" (still used)
- Keep govmomi imports (object, types)

Per established decisions: Keep _govmomi function names (Phase 6 will rename). Keep useGovmomi flag unused but don't remove it (Phase 6 handles).
  </action>
  <verify>
Run `go build ./...` to verify compilation succeeds with no errors.
Run `go test ./esxi/ -v -run "TestDiskStore|TestVirtualDisk|TestBuildAllocation"` to verify all virtual disk tests maintain baseline (TestDiskStoreValidateGovmomi PASS, TestBuildAllocationInfo PASS; TestVirtualDiskCreateReadGovmomi is a pre-existing simulator limitation failure).
  </verify>
  <done>
virtual-disk_functions.go contains zero SSH code paths. Four wrapper functions (diskStoreValidate, virtualDiskCREATE, virtualDiskREAD, growVirtualDisk) directly call their _govmomi counterparts. New virtualDiskDelete_govmomi function exists using VirtualDiskManager.DeleteVirtualDisk. No references to runRemoteSshCommand, getConnectionInfo, or esxiConnInfo remain in the file. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite virtual-disk_delete.go and implement data source browser</name>
  <files>esxi/virtual-disk_delete.go, esxi/data_source_esxi_virtual_disk.go</files>
  <action>
**Part A: Rewrite virtual-disk_delete.go**

Replace the entire SSH-based resourceVIRTUALDISKDelete function with a govmomi-based version:

```go
func resourceVIRTUALDISKDelete(d *schema.ResourceData, m interface{}) error {
    c := m.(*Config)
    log.Println("[resourceVIRTUALDISKDelete]")

    virtdisk_id := d.Id()

    err := virtualDiskDelete_govmomi(c, virtdisk_id)
    if err != nil {
        return fmt.Errorf("Failed to delete virtual disk: %w", err)
    }

    d.SetId("")
    return nil
}
```

Key changes from SSH version:
- Remove getConnectionInfo/esxiConnInfo (no SSH)
- Remove manual vmkfstools -U command
- Remove directory emptiness check and rmdir logic (govmomi handles cleanup)
- Remove virtual_disk_disk_store and virtual_disk_dir from d.Get() calls (not needed -- virtdisk_id contains full path)
- Call virtualDiskDelete_govmomi (from Task 1) which handles idempotent delete

Clean up imports: Remove "strings" (no longer needed). Keep "fmt", "log", "github.com/hashicorp/terraform/helper/schema".

**Part B: Implement findVirtualDiskInDir_govmomi in data_source_esxi_virtual_disk.go**

Step 1: Replace findVirtualDiskInDir SSH branch with thin wrapper (lines 104-135):
```go
func findVirtualDiskInDir(c *Config, diskStore, dir string) (string, error) {
    return findVirtualDiskInDir_govmomi(c, diskStore, dir)
}
```

Step 2: Replace the stub findVirtualDiskInDir_govmomi (lines 138-142) with full implementation using HostDatastoreBrowser.SearchDatastore:
- Get govmomi client, get datastore via getDatastoreByName
- Get datastore browser via ds.Browser()
- Create HostDatastoreBrowserSearchSpec with MatchPattern: []string{"*.vmdk"} and FileSize: false
- Search with browser.SearchDatastore(gc.Context(), ds.Path(dir), &spec)
- Wait for result via task.WaitForResult()
- Cast result to types.HostDatastoreBrowserSearchResults
- Iterate result.File, skip -flat.vmdk files, return first descriptor .vmdk filename
- Return empty string (not error) if no vmdk found

Step 3: Clean up imports: Remove "path/filepath" (only used by SSH findVirtualDiskInDir). Add "github.com/vmware/govmomi/vim25/types" (needed for search spec). Keep "fmt", "log", "strings", "github.com/hashicorp/terraform/helper/schema".

Note: dataSourceVirtualDiskRead already calls diskStoreValidate and virtualDiskREAD as wrapper functions, so it automatically benefits from Task 1's wrapper simplification with no changes needed.
  </action>
  <verify>
Run `go build ./...` to verify compilation succeeds.
Run `go test ./esxi/ -v` to verify full test suite maintains baseline (27 pass, 5 fail -- same pre-existing failures).
Verify no SSH references remain: `grep -r "runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo" esxi/virtual-disk_delete.go esxi/data_source_esxi_virtual_disk.go esxi/virtual-disk_functions.go` should return no results.
  </verify>
  <done>
virtual-disk_delete.go uses virtualDiskDelete_govmomi with no SSH code. data_source_esxi_virtual_disk.go has working findVirtualDiskInDir_govmomi using datastore browser API and findVirtualDiskInDir is a thin wrapper. No SSH references remain in any virtual disk file. Full test suite maintains 27/32 passing baseline. Build succeeds cleanly.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds with no compilation errors
2. `go test ./esxi/ -v` shows same test baseline (27 pass, 5 fail from pre-existing simulator limitations)
3. `grep -rn "runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo" esxi/virtual-disk*.go esxi/data_source_esxi_virtual_disk.go` returns zero results
4. `grep -n "func diskStoreValidate\b\|func virtualDiskCREATE\b\|func virtualDiskREAD\b\|func growVirtualDisk\b\|func findVirtualDiskInDir\b" esxi/virtual-disk_functions.go esxi/data_source_esxi_virtual_disk.go` shows all wrapper functions exist
5. `grep -n "func virtualDiskDelete_govmomi" esxi/virtual-disk_functions.go` confirms new delete function exists
</verification>

<success_criteria>
- VDISK-01: virtual-disk_functions.go contains no SSH code paths (all 4 functions are thin wrappers)
- VDISK-02: virtual-disk_delete.go uses govmomi delete (virtualDiskDelete_govmomi implemented and called)
- VDISK-03: data_source_esxi_virtual_disk.go has no SSH fallback (findVirtualDiskInDir is thin wrapper, findVirtualDiskInDir_govmomi fully implemented)
- VDISK-04: All virtual disk tests pass at same baseline (27/32 overall)
- Path format preserved: /vmfs/volumes/ in Terraform state, [datastore] for API calls
- No regression in non-virtual-disk tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-remove-ssh-from-virtual-disk/05-01-SUMMARY.md`
</output>
