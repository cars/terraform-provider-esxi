---
phase: 04-remove-ssh-from-resource-pool
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - esxi/resource-pool_functions.go
  - esxi/resource-pool_create.go
  - esxi/resource-pool_update.go
  - esxi/resource-pool_delete.go
  - esxi/resource-pool_import.go
autonomous: true

must_haves:
  truths:
    - "resource-pool_functions.go contains no SSH code paths — getPoolID, getPoolNAME, resourcePoolRead are thin wrappers calling _govmomi implementations"
    - "resource-pool_create.go calls resourcePoolCreate_govmomi directly without useGovmomi conditional or SSH fallback"
    - "resource-pool_update.go calls resourcePoolUpdate_govmomi directly without SSH rename or SSH config update branches"
    - "resource-pool_delete.go calls resourcePoolDelete_govmomi directly without useGovmomi conditional or SSH fallback"
    - "resource-pool_import.go uses govmomi-based shared functions for verification"
    - "All resource pool tests pass (create/read/delete) and update test fails only due to known simulator limitation"
    - "No regressions in full test suite (27/32 tests passing baseline maintained)"
  artifacts:
    - path: "esxi/resource-pool_functions.go"
      provides: "Thin wrapper functions routing to govmomi implementations"
      contains: "return getPoolID_govmomi"
    - path: "esxi/resource-pool_create.go"
      provides: "Direct govmomi pool creation"
      contains: "resourcePoolCreate_govmomi"
    - path: "esxi/resource-pool_update.go"
      provides: "Direct govmomi pool update"
      contains: "resourcePoolUpdate_govmomi"
    - path: "esxi/resource-pool_delete.go"
      provides: "Direct govmomi pool deletion"
      contains: "resourcePoolDelete_govmomi"
  key_links:
    - from: "esxi/resource-pool_functions.go"
      to: "esxi/resource-pool_functions.go (govmomi implementations)"
      via: "thin wrapper functions"
      pattern: "return (getPoolID_govmomi|getPoolNAME_govmomi|resourcePoolRead_govmomi)"
    - from: "esxi/data_source_esxi_resource_pool.go"
      to: "esxi/resource-pool_functions.go"
      via: "shared functions getPoolID and resourcePoolRead (auto-fixed by wrapper pattern)"
      pattern: "(getPoolID|resourcePoolRead)\\("
    - from: "esxi/guest-create.go"
      to: "esxi/resource-pool_functions.go"
      via: "getPoolID called for VM resource pool placement"
      pattern: "getPoolID\\("
---

<objective>
Remove all SSH code paths from the resource pool resource, making it operate entirely via govmomi API.

Purpose: Continues the systematic SSH removal (Phase 2 portgroup, Phase 3 vswitch, now resource pool). Eliminates SSH dependencies from another resource type, moving closer to a govmomi-only provider.

Output: Resource pool resource with no SSH code, all operations routing through govmomi, tests passing.
</objective>

<execution_context>
@/home/cars/.claude/get-shit-done/workflows/execute-plan.md
@/home/cars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-remove-ssh-from-resource-pool/04-RESEARCH.md
@.planning/phases/02-remove-ssh-from-portgroup/02-01-SUMMARY.md
@esxi/resource-pool_functions.go
@esxi/resource-pool_create.go
@esxi/resource-pool_update.go
@esxi/resource-pool_delete.go
@esxi/resource-pool_import.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove SSH branches from resource pool CRUD functions</name>
  <files>
    esxi/resource-pool_functions.go
    esxi/resource-pool_create.go
    esxi/resource-pool_update.go
    esxi/resource-pool_delete.go
  </files>
  <action>
Apply the proven Phase 2/3 wrapper pattern to remove all SSH code from resource pool operations.

**resource-pool_functions.go (3 changes + import cleanup):**

1. Replace `getPoolID` function (lines 17-44) with thin wrapper:
```go
func getPoolID(c *Config, resource_pool_name string) (string, error) {
    return getPoolID_govmomi(c, resource_pool_name)
}
```

2. Replace `getPoolNAME` function (lines 47-97) with thin wrapper:
```go
func getPoolNAME(c *Config, resource_pool_id string) (string, error) {
    return getPoolNAME_govmomi(c, resource_pool_id)
}
```

3. Replace `resourcePoolRead` function (lines 99-190) with thin wrapper:
```go
func resourcePoolRead(c *Config, pool_id string) (string, int, string, int, string, int, string, int, string, error) {
    return resourcePoolRead_govmomi(c, pool_id)
}
```

4. Clean up imports: Remove `bufio`, `regexp` — these are only used by SSH code. Keep `fmt`, `log`, `strconv`, `strings` (used by govmomi functions like buildAllocationInfo). Keep all govmomi imports.

**resource-pool_create.go (remove SSH branch + clean vars/imports):**

1. Remove `esxiConnInfo := getConnectionInfo(c)` (line 14) and `var remote_cmd` from var declaration (line 17).
2. Remove the entire `if c.useGovmomi { ... } else { ... }` block (lines 102-128) and replace with the direct govmomi call only:
```go
pool_id, err = resourcePoolCreate_govmomi(c, resource_pool_name, cpu_min, cpu_min_expandable,
    cpu_max, cpu_shares, mem_min, mem_min_expandable, mem_max, mem_shares, parent_pool)
if err != nil {
    d.SetId("")
    return fmt.Errorf("Failed to create pool: %s\n", err)
}
```
3. Remove all the SSH option-building variables (cpu_min_opt, cpu_min_expandable_opt, cpu_max_opt, cpu_shares_opt, mem_min_opt, mem_min_expandable_opt, mem_max_opt, mem_shares_opt — lines 52-100). These were only used to build the vim-cmd SSH command.
4. Clean up imports: Remove `strconv` if no longer used after removing SSH option-building code. Keep `fmt`, `log`, `strings`.

**resource-pool_update.go (remove SSH branches + clean vars/imports):**

1. Remove `esxiConnInfo := getConnectionInfo(c)` (line 14).
2. Remove `var remote_cmd, stdout string` (line 17) — only `var err error` needed.
3. Remove SSH rename block (lines 38-49): the `getPoolNAME` call, conditional check, `vim-cmd hostsvc/rsrc/rename` command. The govmomi update function (resourcePoolUpdate_govmomi) already handles rename internally.
4. Remove all SSH option-building variables (cpu_min_opt through mem_shares_opt — lines 51-99). These built the vim-cmd SSH command.
5. Remove the `if c.useGovmomi { ... } else { ... }` block (lines 101-119) and replace with direct govmomi call:
```go
err = resourcePoolUpdate_govmomi(c, pool_id, resource_pool_name, cpu_min, cpu_min_expandable,
    cpu_max, cpu_shares, mem_min, mem_min_expandable, mem_max, mem_shares)
if err != nil {
    return fmt.Errorf("Failed to update pool: %s\n", err)
}
```
6. Clean up imports: Remove `strconv` if unused. Keep `fmt`, `log`, `strings`.

**resource-pool_delete.go (remove SSH branch):**

1. Remove the entire `if c.useGovmomi { ... } else { ... }` block (lines 16-35) and replace with direct govmomi call:
```go
err := resourcePoolDelete_govmomi(c, pool_id)
if err != nil {
    log.Printf("[resourceRESOURCEPOOLDelete] Failed destroy resource pool id: %s\n", pool_id)
    return fmt.Errorf("Failed to delete pool: %s\n", err)
}
```
2. No import changes needed (fmt and log are still used).

**Key constraints (from Phase 2/3 decisions):**
- Do NOT rename _govmomi functions (Phase 6 handles that)
- Do NOT remove useGovmomi flag from Config (Phase 6 handles that)
- Do NOT modify data_source_esxi_resource_pool.go (auto-fixes via shared functions)
- Do NOT modify resource-pool_import.go in this task (already govmomi-based, verified in Task 2)

After all changes, run `go build ./...` to verify clean compilation.
  </action>
  <verify>
1. `go build ./...` compiles without errors
2. Verify no SSH identifiers remain in modified files:
   - `grep -r "runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo\|esxcli\|vim-cmd\|remote_cmd" esxi/resource-pool_functions.go esxi/resource-pool_create.go esxi/resource-pool_update.go esxi/resource-pool_delete.go` returns no matches
3. Verify wrapper functions exist:
   - `grep "return getPoolID_govmomi" esxi/resource-pool_functions.go`
   - `grep "return getPoolNAME_govmomi" esxi/resource-pool_functions.go`
   - `grep "return resourcePoolRead_govmomi" esxi/resource-pool_functions.go`
  </verify>
  <done>
All four resource pool files (functions, create, update, delete) contain zero SSH code paths. Wrapper functions directly call govmomi implementations. Build compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify import function and run full test suite</name>
  <files>
    esxi/resource-pool_import.go
  </files>
  <action>
1. **Inspect resource-pool_import.go**: Confirm it already uses govmomi-based shared functions (getPoolNAME wrapper). The current import function calls `getPoolNAME(c, d.Id())` which now routes to `getPoolNAME_govmomi` via the wrapper from Task 1. No changes should be needed — but verify there are no SSH references.

2. **If SSH references found in import file**: Rewrite to match the Phase 2 portgroup pattern:
```go
func resourceRESOURCEPOOLImport(d *schema.ResourceData, m interface{}) ([]*schema.ResourceData, error) {
    c := m.(*Config)
    log.Println("[resourceRESOURCEPOOLImport]")

    results := make([]*schema.ResourceData, 1, 1)
    results[0] = d

    _, err := getPoolNAME(c, d.Id())
    if err != nil {
        return results, fmt.Errorf("Failed to import resource pool '%s': %s", d.Id(), err)
    }

    d.SetId(d.Id())
    return results, nil
}
```

3. **Run resource pool tests**: `go test ./esxi/ -v -run TestResourcePool`
   - Expected PASS: TestResourcePoolCreateReadDeleteGovmomi
   - Expected FAIL: TestResourcePoolUpdateGovmomi (known simulator limitation — vcsim does not implement Rename_Task)

4. **Run full test suite**: `go test ./esxi/ -v`
   - Expected: 27/32 passing (same baseline as Phase 3)
   - Any regression (fewer than 27 passing) is a blocker that must be investigated

5. **Verify data source auto-fix**: Confirm `data_source_esxi_resource_pool.go` calls `getPoolID` and `resourcePoolRead` (no modifications needed — these shared functions now route to govmomi).
  </action>
  <verify>
1. `grep -r "runRemoteSshCommand\|getConnectionInfo\|esxiConnInfo\|esxcli\|vim-cmd\|remote_cmd" esxi/resource-pool_import.go` returns no matches
2. `go test ./esxi/ -v -run TestResourcePool` shows TestResourcePoolCreateReadDeleteGovmomi PASS
3. `go test ./esxi/ -v` shows at least 27 tests passing (no regressions from Phase 3 baseline)
4. `grep "getPoolID\|resourcePoolRead" esxi/data_source_esxi_resource_pool.go` confirms shared function usage (no SSH-specific code)
  </verify>
  <done>
Import function uses govmomi-based shared functions. Resource pool create/read/delete tests pass. Full test suite maintains 27/32 baseline. Data source auto-fixed via shared function routing.
  </done>
</task>

</tasks>

<verification>
1. **Build:** `go build ./...` succeeds with no errors
2. **SSH elimination:** Zero SSH identifiers (runRemoteSshCommand, getConnectionInfo, esxiConnInfo, vim-cmd, esxcli, remote_cmd) in any resource pool file (functions, create, update, delete, import)
3. **Govmomi routing:** Three wrapper functions in resource-pool_functions.go directly call _govmomi implementations
4. **Tests:** Resource pool create/read/delete tests pass; full suite maintains 27/32 baseline
5. **No regressions:** Guest VM tests still pass (getPoolID dependency works correctly)
6. **Data source:** data_source_esxi_resource_pool.go unmodified and functional via shared functions
</verification>

<success_criteria>
- resource-pool_functions.go, resource-pool_create.go, resource-pool_update.go, resource-pool_delete.go contain zero SSH code
- resource-pool_import.go uses govmomi-based shared functions
- `go build ./...` succeeds
- `go test ./esxi/ -v -run TestResourcePool` passes create/read/delete (update fails due to simulator limitation)
- `go test ./esxi/ -v` shows at least 27/32 tests passing (no regressions)
- data_source_esxi_resource_pool.go unmodified and operational
</success_criteria>

<output>
After completion, create `.planning/phases/04-remove-ssh-from-resource-pool/04-01-SUMMARY.md`
</output>
