---
phase: 02-remove-ssh-from-portgroup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - esxi/portgroup_functions.go
  - esxi/portgroup_create.go
  - esxi/portgroup_update.go
  - esxi/portgroup_delete.go
  - esxi/portgroup_import.go
autonomous: true

must_haves:
  truths:
    - "portgroupRead calls portgroupRead_govmomi directly without SSH branch"
    - "portgroupSecurityPolicyRead calls portgroupSecurityPolicyRead_govmomi directly without SSH branch"
    - "resourcePORTGROUPCreate calls portgroupCreate_govmomi directly without SSH branch"
    - "resourcePORTGROUPUpdate calls portgroupUpdate_govmomi directly without SSH branch"
    - "resourcePORTGROUPDelete calls portgroupDelete_govmomi directly without SSH branch"
    - "resourcePORTGROUPImport uses portgroupRead (govmomi) instead of SSH"
    - "All portgroup tests pass (except TestPortgroupUpdateGovmomi — known simulator limitation)"
  artifacts:
    - path: "esxi/portgroup_functions.go"
      provides: "SSH-free portgroupRead and portgroupSecurityPolicyRead wrapper functions"
      contains: "portgroupRead_govmomi"
    - path: "esxi/portgroup_create.go"
      provides: "SSH-free portgroup create"
      contains: "portgroupCreate_govmomi"
    - path: "esxi/portgroup_update.go"
      provides: "SSH-free portgroup update"
      contains: "portgroupUpdate_govmomi"
    - path: "esxi/portgroup_delete.go"
      provides: "SSH-free portgroup delete"
      contains: "portgroupDelete_govmomi"
    - path: "esxi/portgroup_import.go"
      provides: "Govmomi-based import using portgroupRead"
      contains: "portgroupRead"
  key_links:
    - from: "esxi/portgroup_functions.go"
      to: "portgroupRead_govmomi, portgroupSecurityPolicyRead_govmomi"
      via: "direct function call (no conditional)"
      pattern: "return portgroupRead_govmomi"
    - from: "esxi/portgroup_import.go"
      to: "portgroupRead"
      via: "import verifies existence via govmomi read"
      pattern: "portgroupRead\\(c, d\\.Id\\(\\)\\)"
    - from: "esxi/portgroup_read.go"
      to: "portgroupRead, portgroupSecurityPolicyRead"
      via: "unchanged callers now route through govmomi"
      pattern: "portgroupRead\\(c, name\\)"
    - from: "esxi/data_source_esxi_portgroup.go"
      to: "portgroupRead, portgroupSecurityPolicyRead"
      via: "unchanged data source now routes through govmomi"
      pattern: "portgroupRead\\(c, name\\)"
---

<objective>
Remove all SSH code paths from portgroup resource files, leaving only govmomi API implementations.

Purpose: Establish the SSH removal pattern on the smallest resource. After this plan, the portgroup resource operates entirely via govmomi. The data source (data_source_esxi_portgroup.go) is fixed automatically because it calls shared portgroupRead/portgroupSecurityPolicyRead functions.

Output: 5 modified files with SSH code deleted, import function rewritten to use govmomi.
</objective>

<execution_context>
@/home/cars/.claude/get-shit-done/workflows/execute-plan.md
@/home/cars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-remove-ssh-from-portgroup/02-RESEARCH.md
@esxi/portgroup_functions.go
@esxi/portgroup_create.go
@esxi/portgroup_update.go
@esxi/portgroup_delete.go
@esxi/portgroup_import.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove SSH branches from portgroup CRUD functions</name>
  <files>
    esxi/portgroup_functions.go
    esxi/portgroup_create.go
    esxi/portgroup_update.go
    esxi/portgroup_delete.go
  </files>
  <action>
Delete SSH conditional branches from 4 files. Keep the `_govmomi` function names (Phase 6 renames them). Keep `useGovmomi` flag (Phase 6 removes it). Do NOT touch config.go, esxi_remote_cmds.go, or any non-portgroup files.

**portgroup_functions.go:**
- `portgroupRead` (lines 21-58): Remove the `if c.useGovmomi` conditional and the entire SSH else-branch (lines 27-57). Result: function body is just `return portgroupRead_govmomi(c, name)`.
- `portgroupSecurityPolicyRead` (lines 60-81): Remove the `if c.useGovmomi` conditional and the entire SSH else-branch (lines 66-80). Result: function body is just `return portgroupSecurityPolicyRead_govmomi(c, name)`.
- Clean up unused imports after SSH removal: `regexp`, `strconv`, `strings`, `csvutil` will become unused. Remove them from the import block. Keep `fmt`, `log`, `mo`, `types`.

**portgroup_create.go:**
- `resourcePORTGROUPCreate` (lines 18-38): Remove the `if c.useGovmomi` conditional and the entire SSH else-branch (lines 24-38). Result: just the govmomi call `err := portgroupCreate_govmomi(c, name, vswitch)` followed by the error check setting `d.SetId("")`.
- Clean up unused imports: `fmt` stays (used by error formatting), `log` stays, `schema` stays. The SSH branch uses no extra imports beyond what govmomi path uses.

**portgroup_update.go:**
- `resourcePORTGROUPUpdate` (lines 34-75): Remove the `if c.useGovmomi` conditional and the entire SSH else-branch (lines 39-75). Result: just the govmomi call `err := portgroupUpdate_govmomi(...)` followed by the error check.
- Clean up unused imports: `errors` stays (used for validation), `fmt` stays, `log` stays, `schema` stays.

**portgroup_delete.go:**
- `resourcePORTGROUPDelete` (lines 16-37): Remove the `if c.useGovmomi` conditional and the entire SSH else-branch (lines 22-37). Result: just the govmomi call `err := portgroupDelete_govmomi(c, name)` followed by the error check.
- Clean up unused imports: `fmt` stays, `log` stays, `schema` stays.
  </action>
  <verify>
Run `go build ./...` to confirm clean compilation (no unused import errors, no missing references). Verify no SSH-related identifiers remain in portgroup files: search for `runRemoteSshCommand`, `getConnectionInfo`, `esxiConnInfo`, `remote_cmd` in the 4 modified files — should find zero matches.
  </verify>
  <done>
All 4 files contain only govmomi code paths. `portgroupRead` and `portgroupSecurityPolicyRead` are thin wrappers that directly call their `_govmomi` counterparts. CRUD functions call govmomi functions directly. No SSH identifiers remain in any portgroup file except portgroup_import.go (handled in Task 2). Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite portgroup import to use govmomi and verify all tests pass</name>
  <files>
    esxi/portgroup_import.go
  </files>
  <action>
**Rewrite portgroup_import.go** to replace the SSH-based import with a govmomi-based approach that calls the existing `portgroupRead` function (which now routes to govmomi per Task 1).

Replace the entire function body of `resourcePORTGROUPImport` with:

```go
func resourcePORTGROUPImport(d *schema.ResourceData, m interface{}) ([]*schema.ResourceData, error) {
	c := m.(*Config)
	log.Println("[resourcePORTGROUPImport]")

	results := make([]*schema.ResourceData, 1, 1)
	results[0] = d

	// Use govmomi to verify portgroup exists
	_, _, err := portgroupRead(c, d.Id())
	if err != nil {
		return results, fmt.Errorf("Failed to import portgroup '%s': %s", d.Id(), err)
	}

	d.SetId(d.Id())
	d.Set("name", d.Id())

	return results, nil
}
```

Clean up imports: Remove any SSH-related imports. Keep `fmt`, `log`, `schema`.

**Run the full test suite** with `go test ./esxi/ -v` to verify:
1. All portgroup tests pass (TestPortgroupCreateReadDeleteGovmomi, TestPortgroupSecurityPolicyReadGovmomi, TestPortgroupNonExistentGovmomi should pass)
2. TestPortgroupUpdateGovmomi will fail — this is a KNOWN simulator limitation (vcsim does not implement UpdatePortGroup). This is expected and not a regression.
3. No other tests are broken by the portgroup changes (verify non-portgroup tests still pass).
  </action>
  <verify>
Run `go test ./esxi/ -v -run TestPortgroup` and confirm 3/4 tests pass (TestPortgroupUpdateGovmomi fails due to simulator limitation — expected). Run `go build ./...` one final time to confirm clean build. Search all 5 modified portgroup files for `runRemoteSshCommand`, `getConnectionInfo`, `esxiConnInfo`, `esxcli` — should find zero matches.
  </verify>
  <done>
portgroup_import.go uses portgroupRead (govmomi) instead of SSH. All 5 portgroup files are SSH-free. 3/4 portgroup tests pass (1 known simulator limitation). Full test suite shows no regressions from portgroup changes. Build succeeds cleanly.
  </done>
</task>

</tasks>

<verification>
Phase-level verification after all tasks complete:

1. **No SSH code in portgroup files:** Search all files matching `esxi/portgroup*.go` (excluding test) for SSH indicators: `runRemoteSshCommand`, `getConnectionInfo`, `esxiConnInfo`, `esxcli`, `remote_cmd`. Zero matches expected.
2. **Govmomi routing intact:** `portgroupRead` calls `portgroupRead_govmomi`. `portgroupSecurityPolicyRead` calls `portgroupSecurityPolicyRead_govmomi`. Create/Update/Delete call their `_govmomi` counterparts directly.
3. **Data source works automatically:** `data_source_esxi_portgroup.go` calls `portgroupRead` and `portgroupSecurityPolicyRead` — no changes needed, govmomi routing flows through.
4. **Build clean:** `go build ./...` succeeds.
5. **Tests pass:** `go test ./esxi/ -v` shows 3/4 portgroup tests passing (TestPortgroupUpdateGovmomi is known simulator limitation).
6. **No collateral damage:** Non-portgroup tests unaffected. config.go, esxi_remote_cmds.go, govmomi_client.go untouched.
</verification>

<success_criteria>
- portgroup_functions.go contains zero SSH code paths (no `runRemoteSshCommand`, no `getConnectionInfo`, no `esxcli`)
- portgroup_create.go, portgroup_update.go, portgroup_delete.go contain zero `if c.useGovmomi` conditionals — they call govmomi functions directly
- portgroup_import.go uses `portgroupRead()` (govmomi) instead of SSH
- `go build ./...` exits 0
- `go test ./esxi/ -v -run TestPortgroup` shows 3 PASS, 1 FAIL (known simulator limitation)
- No regressions in non-portgroup tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-remove-ssh-from-portgroup/02-01-SUMMARY.md`
</output>
