---
phase: 06-infrastructure-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - esxi/config.go
  - esxi/guest_functions.go
  - esxi/guest-read.go
  - esxi/data_source_esxi_guest.go
  - esxi/data_source_esxi_host.go
  - esxi/guest_device_info_test.go
  - esxi/vswitch_functions_test.go
  - esxi/portgroup_functions_test.go
  - esxi/govmomi_helpers_test.go
  - esxi/resource-pool_functions_test.go
  - esxi/govmomi_client_test.go
  - esxi/virtual-disk_functions_test.go
autonomous: true

must_haves:
  truths:
    - "useGovmomi field no longer exists in Config struct"
    - "All test files compile without useGovmomi field references"
    - "Guest operations (guestGetVMID, guestValidateVMID, guestPowerOn, guestPowerOff, guestPowerGetState, guestGetIpAddress) use SSH directly without conditional routing"
    - "guestREAD uses SSH directly without conditional routing"
    - "data_source_esxi_guest reads device info unconditionally via govmomi"
    - "data_source_esxi_host uses govmomi directly without conditional routing"
    - "Provider builds and all tests pass"
  artifacts:
    - path: "esxi/config.go"
      provides: "Config struct without useGovmomi field"
      contains: "govmomiClient \\*GovmomiClient"
    - path: "esxi/guest_functions.go"
      provides: "Guest functions with SSH-only paths (no useGovmomi conditionals)"
    - path: "esxi/guest-read.go"
      provides: "guestREAD with SSH-only path (no useGovmomi conditional)"
    - path: "esxi/data_source_esxi_guest.go"
      provides: "Guest data source with unconditional govmomi device info reading"
    - path: "esxi/data_source_esxi_host.go"
      provides: "Host data source calling govmomi directly"
  key_links:
    - from: "esxi/guest_functions.go"
      to: "esxi/esxi_remote_cmds.go"
      via: "runRemoteSshCommand calls retained for guest operations"
      pattern: "runRemoteSshCommand"
    - from: "esxi/data_source_esxi_guest.go"
      to: "esxi/guest_device_info.go"
      via: "guestReadDevices_govmomi called unconditionally"
      pattern: "guestReadDevices_govmomi"
    - from: "esxi/data_source_esxi_host.go"
      to: "dataSourceEsxiHostReadGovmomi"
      via: "Direct call replacing conditional"
      pattern: "dataSourceEsxiHostReadGovmomi"
---

<objective>
Remove the useGovmomi feature flag from the Config struct and clean all conditional routing in guest operations and data sources. After this plan, no code references useGovmomi anywhere.

Purpose: Eliminates dead feature flag that was kept during phases 2-5 SSH removal. Guest operations keep SSH path (no govmomi alternative), data sources keep govmomi path (preferred). This is the prerequisite for function renaming in Plan 02.
Output: Config struct without useGovmomi field, all conditional routing removed, all tests compile and pass.
</objective>

<execution_context>
@/home/cars/.claude/get-shit-done/workflows/execute-plan.md
@/home/cars/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-infrastructure-cleanup/06-RESEARCH.md
@esxi/config.go
@esxi/guest_functions.go
@esxi/guest-read.go
@esxi/data_source_esxi_guest.go
@esxi/data_source_esxi_host.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove useGovmomi field from Config and all test files</name>
  <files>
    esxi/config.go
    esxi/guest_device_info_test.go
    esxi/vswitch_functions_test.go
    esxi/portgroup_functions_test.go
    esxi/govmomi_helpers_test.go
    esxi/resource-pool_functions_test.go
    esxi/govmomi_client_test.go
    esxi/virtual-disk_functions_test.go
  </files>
  <action>
    1. In esxi/config.go: Delete the `useGovmomi bool` field (line 18) and its comment from the Config struct. Update the comment above govmomiClient from "New fields for govmomi" to just "govmomi client" (no longer "new").

    2. Remove `useGovmomi: true,` from ALL Config struct literals in test files (27 occurrences across 8 files):
       - esxi/guest_device_info_test.go (3 occurrences: lines 28, 103, 164)
       - esxi/vswitch_functions_test.go (2 occurrences: lines 27, 105)
       - esxi/portgroup_functions_test.go (4 occurrences: lines 27, 100, 195, 253)
       - esxi/govmomi_helpers_test.go (6 occurrences: lines 27, 71, 120, 166, 210, 254)
       - esxi/resource-pool_functions_test.go (3 occurrences: lines 27, 121, 217)
       - esxi/govmomi_client_test.go (1 occurrence: line 318)
       - esxi/virtual-disk_functions_test.go (2 occurrences: lines 27, 75)

    3. After removing the field, verify no remaining references: `grep -rn "useGovmomi" esxi/` should return ZERO matches (except for files being modified in Task 2).

    IMPORTANT: Do NOT remove the govmomiClient field or any SSH infrastructure (esxi_remote_cmds.go, ConnectionStruct, getConnectionInfo). Guest operations require SSH.
  </action>
  <verify>
    Run `grep -rn "useGovmomi" esxi/*_test.go esxi/config.go` - should return zero matches.
    Run `go build ./...` from repo root - must compile successfully.
  </verify>
  <done>Config struct has no useGovmomi field. All 27 test occurrences removed. Code compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Clean useGovmomi conditionals from guest operations and data sources</name>
  <files>
    esxi/guest_functions.go
    esxi/guest-read.go
    esxi/data_source_esxi_guest.go
    esxi/data_source_esxi_host.go
  </files>
  <action>
    Clean conditionals in 4 files. The rule is: guest operations that use SSH keep the SSH path (delete the govmomi branch). Data sources that use govmomi keep the govmomi path (delete the SSH branch).

    1. esxi/guest_functions.go - Remove 6 useGovmomi conditionals, KEEPING the SSH path each time:
       - guestGetVMID (line 14): Delete `if c.useGovmomi { return guestGetVMID_govmomi(c, guest_name) }` block. Keep the SSH implementation below it.
       - guestValidateVMID (line 40): Delete `if c.useGovmomi { return guestValidateVMID_govmomi(c, vmid) }` block. Keep SSH.
       - guestPowerOn (line 407): Delete `if c.useGovmomi { return guestPowerOn_govmomi(c, vmid) }` block. Keep SSH.
       - guestPowerOff (line 432): Delete `if c.useGovmomi { return guestPowerOff_govmomi(c, vmid, guest_shutdown_timeout) }` block. Keep SSH.
       - guestPowerGetState (line 476): Delete `if c.useGovmomi { return guestPowerGetState_govmomi(c, vmid) }` block. Keep SSH.
       - guestGetIpAddress (line 503): Delete `if c.useGovmomi { return guestGetIpAddress_govmomi(c, vmid, guest_startup_timeout) }` block. Keep SSH.
       Also remove any "// Fallback to SSH" comments since SSH is now THE implementation, not a fallback. Remove "// Use govmomi if enabled" comments.

    2. esxi/guest-read.go - Remove guestREAD conditional (line 91):
       - Delete `if c.useGovmomi { return guestREAD_govmomi(c, vmid, guest_startup_timeout) }` block. Keep SSH path below.
       - Remove "// Fallback to SSH" and "// Use govmomi if enabled" comments.

    3. esxi/data_source_esxi_guest.go - Remove device info conditional (line 448):
       - Change `if c.useGovmomi { ... }` block to unconditional execution. Remove the `if c.useGovmomi {` and closing `}`. Keep all the code inside the block (guestReadDevices_govmomi call and d.Set calls).

    4. esxi/data_source_esxi_host.go - Remove read routing conditional (line 118):
       - Replace the function body of dataSourceEsxiHostRead to call dataSourceEsxiHostReadGovmomi directly (delete the `if c.useGovmomi` conditional and the SSH fallback branch).
       - The function should become: `return dataSourceEsxiHostReadGovmomi(d, c)`
       - NOTE: Keep the dataSourceEsxiHostReadSSH function in the file - do NOT delete it. It may be useful later and removing it would require removing all SSH helper functions it calls. The compiler will not error on unused non-exported functions in Go (only unused imports error). Actually - Go DOES error on unused imports but NOT on unused functions. So keeping the SSH function is safe.

    After all changes, verify: `grep -rn "useGovmomi" esxi/` should return ZERO matches across the entire esxi/ directory.
  </action>
  <verify>
    Run `grep -rn "useGovmomi" esxi/` - must return zero matches.
    Run `go build ./...` - must compile successfully.
    Run `go test ./esxi/ -v` - all 27 previously-passing tests must pass (0 new failures).
  </verify>
  <done>Zero references to useGovmomi in entire codebase. Guest operations use SSH directly. Data sources use govmomi directly. Build succeeds. All 27/32 tests pass (5 pre-existing failures unchanged).</done>
</task>

</tasks>

<verification>
1. `grep -rn "useGovmomi" esxi/` returns zero matches
2. `grep -rn "c\.useGovmomi" esxi/` returns zero matches
3. `go build ./...` succeeds
4. `go test ./esxi/ -v` shows same pass/fail pattern as baseline (27 pass, 5 fail from simulator limitations)
5. Guest functions still call runRemoteSshCommand (SSH retained): `grep -n "runRemoteSshCommand" esxi/guest_functions.go` shows multiple matches
6. Data sources still call govmomi: `grep -n "GetGovmomiClient\|guestReadDevices" esxi/data_source_esxi_guest.go` shows matches
</verification>

<success_criteria>
- useGovmomi field removed from Config struct
- All 27 test file occurrences of useGovmomi removed
- 6 conditionals in guest_functions.go cleaned (SSH retained)
- 1 conditional in guest-read.go cleaned (SSH retained)
- 1 conditional in data_source_esxi_guest.go cleaned (govmomi retained)
- 1 conditional in data_source_esxi_host.go cleaned (govmomi retained)
- Zero grep matches for "useGovmomi" in esxi/
- go build ./... succeeds
- go test ./esxi/ -v: 27/32 passing (baseline maintained)
</success_criteria>

<output>
After completion, create `.planning/phases/06-infrastructure-cleanup/06-01-SUMMARY.md`
</output>
